package org.hibernate.solon.integration;

import org.hibernate.jpa.internal.util.PersistenceUtilHelper;

import jakarta.persistence.EntityManagerFactory;
import jakarta.persistence.spi.LoadState;
import jakarta.persistence.spi.PersistenceProvider;
import jakarta.persistence.spi.PersistenceUnitInfo;
import jakarta.persistence.spi.ProviderUtil;
import java.util.Map;

/**
 * 提供 java 配置的数据源支持
 *
 * @author noear
 * @since 2.5
 * */
public class JpaPersistenceProvider implements PersistenceProvider {
    private final PersistenceUtilHelper.MetadataCache cache = new PersistenceUtilHelper.MetadataCache();

    @Override
    public EntityManagerFactory createEntityManagerFactory(String unitName, Map map) {
        HibernateAdapter tmp = HibernateAdapterManager.getOnly(unitName);

        return tmp.getSessionFactory();
    }

    @Override
    public EntityManagerFactory createContainerEntityManagerFactory(PersistenceUnitInfo unitInfo, Map map) {
        HibernateAdapter tmp = HibernateAdapterManager.getOnly(unitInfo.getPersistenceUnitName());

        return tmp.getSessionFactory();
    }

    @Override
    public void generateSchema(PersistenceUnitInfo unitInfo, Map map) {
        throw new UnsupportedOperationException();
    }

    @Override
    public boolean generateSchema(String unitName, Map map) {
        throw new UnsupportedOperationException();
    }

    @Override
    public ProviderUtil getProviderUtil() {
        return providerUtil;
    }

    private final ProviderUtil providerUtil = new ProviderUtil() {
        @Override
        public LoadState isLoadedWithoutReference(Object proxy, String property) {
            return PersistenceUtilHelper.isLoadedWithoutReference(proxy, property, cache);
        }

        @Override
        public LoadState isLoadedWithReference(Object proxy, String property) {
            return PersistenceUtilHelper.isLoadedWithReference(proxy, property, cache);
        }

        @Override
        public LoadState isLoaded(Object o) {
            return PersistenceUtilHelper.getLoadState(o);
        }
    };
}
